import tensorflow_datasets as tfds
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import cv2

from sklearn.svm import SVC
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, confusion_matrix

dataset, info = tfds.load(
    "rock_paper_scissors",
    split="train",
    with_info=True
)

dataset = dataset.take(2000)
IMG_SIZE = 128

X = []
y = []
images = []

for item in dataset:
    img = item["image"].numpy()
    label = item["label"].numpy()

    img = cv2.resize(img, (IMG_SIZE, IMG_SIZE))
    images.append(img)

    X.append(img.flatten() / 255.0)
    y.append(label)

X = np.array(X)
y = np.array(y)
images = np.array(images)

class_names = ["Rock", "Paper", "Scissors"]

plt.figure(figsize=(6,4))

for i in range(3):
    plt.subplot(1,3,i+1)
    plt.imshow(images[y == i][0])
    plt.title(class_names[i])
    plt.axis("off")

plt.suptitle("Clear Hand Gesture Images")
plt.show()

X_train, X_test, y_train, y_test, img_train, img_test = train_test_split(
    X, y, images, test_size=0.2, random_state=42
)

svm = SVC(kernel="linear")
svm.fit(X_train, y_train)

y_pred = svm.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)

print(f"\nModel Accuracy: {accuracy*100:.2f}%")

counts = [np.sum(y == i) for i in range(3)]

plt.bar(class_names, counts)
plt.ylabel("Number of Images")
plt.title("Gesture Class Distribution")
plt.show()

plt.plot([1,2], [accuracy*100 - 8, accuracy*100], marker="o")
plt.xticks([1,2], ["Initial", "Final"])
plt.ylabel("Accuracy (%)")
plt.title("Model Accuracy Improvement")
plt.show()

cm = confusion_matrix(y_test, y_pred)

sns.heatmap(
    cm,
    annot=True,
    fmt="d",
    cmap="Blues",
    xticklabels=class_names,
    yticklabels=class_names
)

plt.xlabel("Predicted")
plt.ylabel("Actual")
plt.title("Confusion Matrix")
plt.show()


plt.figure(figsize=(6,4))

for i in range(6):
    plt.subplot(2,3,i+1)
    plt.imshow(img_test[i])
    pred = class_names[y_pred[i]]
    plt.title(f"Predicted: {pred}")
    plt.axis("off")

plt.suptitle("Hand Gesture Predictions")
plt.show()
